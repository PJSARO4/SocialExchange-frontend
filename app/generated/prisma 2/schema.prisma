// Prisma schema for Social Exchange
// Supports NextAuth + Instagram/Facebook OAuth

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // URL is now configured in prisma.config.ts for Prisma 7.x
}

// ============================================
// NextAuth Required Models
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  accounts       Account[]
  sessions       Session[]
  socialFeeds    SocialFeed[]
  content        Content[]
  scheduledPosts ScheduledPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// Social Feed Models (Instagram, Facebook, etc.)
// ============================================

model SocialFeed {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Platform info
  platform          Platform
  platformAccountId String // Instagram user ID, Facebook page ID, etc.
  handle            String // @username
  displayName       String
  profilePictureUrl String?

  // OAuth tokens (encrypted in production)
  accessToken        String    @db.Text
  accessTokenExpires DateTime?
  refreshToken       String?   @db.Text

  // Connection state
  isConnected   Boolean   @default(true)
  lastSyncAt    DateTime?
  lastSyncError String?

  // Automation settings
  automationEnabled Boolean     @default(false)
  controlMode       ControlMode @default(MANUAL)

  // Cached metrics (refreshed periodically)
  followers          Int   @default(0)
  following          Int   @default(0)
  postsCount         Int   @default(0)
  engagementRate     Float @default(0)
  avgLikesPerPost    Int   @default(0)
  avgCommentsPerPost Int   @default(0)

  // Relations
  scheduledPosts    ScheduledPostNew[]
  metrics           FeedMetricsHistory[]
  automationRules   AutomationRule[]
  automationActions AutomationAction[]
  rateLimits        RateLimit[]
  jobQueue          JobQueue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, platform, platformAccountId])
  @@index([userId])
  @@index([platform])
}

model FeedMetricsHistory {
  id     String     @id @default(cuid())
  feedId String
  feed   SocialFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  followers      Int
  following      Int
  postsCount     Int
  engagementRate Float

  recordedAt DateTime @default(now())

  @@index([feedId, recordedAt])
}

// ============================================
// Content Library Models
// ============================================

model Content {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content info
  type        ContentType
  title       String?
  description String?     @db.Text

  // File storage
  fileName     String
  fileSize     Int
  mimeType     String
  storageUrl   String // S3, Cloudinary, or local path
  thumbnailUrl String?

  // Metadata
  width    Int?
  height   Int?
  duration Int? // For video, in seconds

  // Organization
  tags   String[]
  source ContentSource @default(UPLOAD)

  // AI-generated content
  aiCaption  String?  @db.Text
  aiHashtags String[]

  // Usage tracking
  usedInPosts ScheduledPost[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
}

// ============================================
// Scheduling Models (Legacy - for NextAuth compat)
// ============================================

model ScheduledPost {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  feedId String

  contentId String?
  content   Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)

  // Post content
  caption   String   @db.Text
  hashtags  String[]
  mediaUrls String[] // Can have multiple media items

  // Scheduling
  scheduledFor DateTime
  timezone     String   @default("UTC")

  // Status tracking
  status         PostStatus @default(SCHEDULED)
  postedAt       DateTime?
  platformPostId String? // ID returned by Instagram/Facebook after posting
  errorMessage   String?
  retryCount     Int        @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([feedId])
  @@index([scheduledFor])
  @@index([status])
}

// ============================================
// NEW: Scalable Scheduled Posts with Job Queue
// ============================================

model ScheduledPostNew {
  id     String     @id @default(cuid())
  feedId String     @map("feed_id")
  feed   SocialFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  // Content
  caption   String    @db.Text
  mediaUrls String[]  @map("media_urls")
  mediaType MediaType @default(IMAGE) @map("media_type")

  // Scheduling
  scheduledFor DateTime @map("scheduled_for")
  timezone     String   @default("UTC")

  // Status tracking
  status          ScheduleStatus @default(PENDING)
  publishedAt     DateTime?      @map("published_at")
  instagramPostId String?        @map("instagram_post_id")

  // Job queue tracking
  jobId     String? @map("job_id")
  attempts  Int     @default(0)
  lastError String? @map("last_error") @db.Text

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([feedId, status])
  @@index([scheduledFor, status])
  @@index([jobId])
  @@map("scheduled_posts_new")
}

enum MediaType {
  IMAGE
  VIDEO
  CAROUSEL
  REELS
}

enum ScheduleStatus {
  PENDING
  QUEUED
  PROCESSING
  PUBLISHED
  FAILED
  CANCELLED
}

// ============================================
// AUTOMATION RULES
// ============================================

model AutomationRule {
  id     String     @id @default(cuid())
  feedId String     @map("feed_id")
  feed   SocialFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  // Rule definition
  name    String
  type    AutomationType
  enabled Boolean        @default(false)

  // Rule settings (JSON for flexibility)
  settings Json @default("{}")

  // Execution schedule
  runInterval Int?      @map("run_interval") // minutes between runs
  lastRunAt   DateTime? @map("last_run_at")
  nextRunAt   DateTime? @map("next_run_at")

  // Stats tracking
  actionsToday Int      @default(0) @map("actions_today")
  actionsTotal Int      @default(0) @map("actions_total")
  statsResetAt DateTime @default(now()) @map("stats_reset_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  actions AutomationAction[]

  @@index([feedId, enabled])
  @@index([nextRunAt, enabled])
  @@map("automation_rules")
}

enum AutomationType {
  ENGAGEMENT // Auto-like, auto-comment
  FOLLOW // Auto-follow based on criteria
  DM // Automated DMs
  COMMENT // Auto-comment templates
}

// ============================================
// AUTOMATION ACTIONS (Execution Log)
// ============================================

model AutomationAction {
  id     String     @id @default(cuid())
  ruleId String     @map("rule_id")
  feedId String     @map("feed_id")
  feed   SocialFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  // Action details
  actionType     ActionType @map("action_type")
  targetType     TargetType @map("target_type")
  targetId       String?    @map("target_id")
  targetUsername String?    @map("target_username")

  // For comments/DMs
  content String? @db.Text

  // Status tracking
  status       ActionStatus @default(PENDING)
  executedAt   DateTime?    @map("executed_at")
  errorMessage String?      @map("error_message") @db.Text

  // Job queue tracking
  jobId    String? @map("job_id")
  attempts Int     @default(0)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  rule AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([ruleId])
  @@index([feedId, actionType])
  @@index([status, createdAt])
  @@index([jobId])
  @@map("automation_actions")
}

enum ActionType {
  LIKE
  COMMENT
  FOLLOW
  UNFOLLOW
  DM
  PUBLISH
}

enum TargetType {
  POST
  USER
  STORY
}

enum ActionStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  RATE_LIMITED
}

// ============================================
// RATE LIMITING
// ============================================

model RateLimit {
  id     String     @id @default(cuid())
  feedId String     @map("feed_id")
  feed   SocialFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  // Action type being limited
  actionType ActionType @map("action_type")

  // Limits
  dailyLimit  Int @default(100) @map("daily_limit")
  hourlyLimit Int @default(30) @map("hourly_limit")

  // Current counts
  dailyCount  Int @default(0) @map("daily_count")
  hourlyCount Int @default(0) @map("hourly_count")

  // Reset timestamps
  dailyResetAt  DateTime @map("daily_reset_at")
  hourlyResetAt DateTime @map("hourly_reset_at")

  // Temporary blocks
  blockedUntil DateTime? @map("blocked_until")
  blockReason  String?   @map("block_reason")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([feedId, actionType])
  @@index([feedId])
  @@map("rate_limits")
}

// ============================================
// JOB QUEUE TRACKING
// ============================================

model JobQueue {
  id String @id @default(cuid())

  // Job identification
  queueName String  @map("queue_name")
  jobType   JobType @map("job_type")

  // Related entity
  entityType String     @map("entity_type") // 'scheduled_post' | 'automation_action'
  entityId   String     @map("entity_id")
  feedId     String     @map("feed_id")
  feed       SocialFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  // Job data (serialized)
  payload Json @default("{}")

  // Scheduling
  scheduledFor DateTime? @map("scheduled_for")
  priority     Int       @default(0)

  // Status
  status      JobStatus @default(PENDING)
  processedAt DateTime? @map("processed_at")
  completedAt DateTime? @map("completed_at")

  // Retry handling
  attempts    Int     @default(0)
  maxAttempts Int     @default(3) @map("max_attempts")
  lastError   String? @map("last_error") @db.Text

  // Worker tracking
  workerId   String?   @map("worker_id")
  lockedAt   DateTime? @map("locked_at")
  lockExpiry DateTime? @map("lock_expiry")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([queueName, status, scheduledFor])
  @@index([feedId])
  @@index([status, lockedAt])
  @@map("job_queue")
}

enum JobType {
  PUBLISH_POST
  AUTO_LIKE
  AUTO_COMMENT
  AUTO_FOLLOW
  AUTO_DM
  FETCH_ANALYTICS
}

enum JobStatus {
  PENDING
  LOCKED
  PROCESSING
  COMPLETED
  FAILED
  DEAD_LETTER
}

// ============================================
// GLOBAL SETTINGS & LIMITS
// ============================================

model SystemConfig {
  id          String  @id @default(cuid())
  key         String  @unique
  value       Json
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

// ============================================
// Enums (Original)
// ============================================

enum Platform {
  INSTAGRAM
  FACEBOOK
  TIKTOK
  TWITTER
  YOUTUBE
  LINKEDIN
}

enum ControlMode {
  AUTOPILOT // Fully automated posting
  ESCROW // Queued for review before posting
  MANUAL // User initiates all posts
  OBSERVATION // Read-only analytics
}

enum ContentType {
  IMAGE
  VIDEO
  CAROUSEL
  STORY
  REEL
}

enum ContentSource {
  UPLOAD // Direct file upload
  CSV_IMPORT // Bulk CSV import
  CLOUD_SYNC // Google Drive, Dropbox, etc.
  AI_GENERATED // Created by AI
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PENDING_REVIEW // For escrow mode
  POSTING
  POSTED
  FAILED
  CANCELLED
}
